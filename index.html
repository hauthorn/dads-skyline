<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Houses</title>

    <style>
        label {
            display: inline-block;
            width: 200px;
        }

        input {
            width: 312px;
        }
    </style>
</head>
<body>
<form onsubmit="return parseTextToHouses()">
    <label for="houses">Enter your list of building here, eg "(1,11,5) (2,6,7)":</label>
    <textarea id="houses" name="houses"></textarea>
    <input type="submit">
</form>
<canvas id="render"></canvas>

<script>
    // Config drawing
    var canvasHeight = 512;
    var canvasWidth = 512;
    var dadsWidth = 30; // The width, from assignment
    var extraThick = 10;
    var bottomLineHeight = canvasHeight - 20;
    var dadsFactor = (canvasWidth / dadsWidth);
    var canvas = document.getElementById("render");
    canvas.height = canvasHeight;
    canvas.width = canvasWidth;
    var ctx = canvas.getContext("2d");
    var stdThick = ctx.lineWidth;
    var stdColor = ctx.strokeStyle;


    // Draw bottom line (thick)
    ctx.beginPath();
    drawBottomLine();
    ctx.closePath();

    function drawBottomLine() {
        ctx.lineWidth = extraThick;
        ctx.moveTo(0, bottomLineHeight);
        ctx.lineTo(canvasWidth, bottomLineHeight);
        ctx.stroke();

        // Draw the ticks
        for (var i = 0; i <= dadsWidth; i += 5) {
            drawLineTick(i * dadsFactor, bottomLineHeight);
        }
    }

    function drawLineTick(x, y) {
        ctx.lineWidth = stdThick;
        ctx.moveTo(x, y - 10);
        ctx.lineTo(x, y + 10);
        ctx.stroke();
    }

    function parseTextToHouses() {
        // Get the value
        var housesString = document.getElementById('houses').value;
        var houseRegEx = /\(\d+,\d+,\d+\)/gm;
        var valRegEx = /\d+/gm;

        var houses = housesString.match(houseRegEx).map(function (houseString) {
            return houseString
                    .match(valRegEx)
                    .map(function(val) { return parseInt(val)}); // Make sure they are ints
        });

        // Draw the houses
        ctx.beginPath();
        houses.forEach(function (house) {
            drawHouse(house)
        });
        ctx.closePath();

        var skylinePoints = calculateSkyline(houses);

        // Draw the skyline
        ctx.beginPath();
        drawSkyline(skylinePoints);
        ctx.closePath();

        return false;
    }

    function drawHouse(house) {
        ctx.lineWidth = 5;
        var actualLeft = house[0] * dadsFactor;
        var actualRight = house[2] * dadsFactor;
        var actualHeight = house[1] * dadsFactor; // Maybe make this a function of the tallest building

        // Go to left point
        ctx.moveTo(actualLeft, bottomLineHeight);
        // Line up
        ctx.lineTo(actualLeft, bottomLineHeight - actualHeight);
        // Line right
        ctx.lineTo(actualRight, bottomLineHeight - actualHeight);

        // Line down
        ctx.lineTo(actualRight, bottomLineHeight);
        ctx.stroke();
    }

    /**
     * Draws the skyline based on the list of points
     * @param points
     */
    function drawSkyline(points) {
        ctx.lineWidth = 3;
        ctx.strokeStyle = '#ff0000';

        ctx.moveTo(points[0] * dadsFactor, bottomLineHeight);

        for (var i = 0; i <= points.length; i += 2) {
            var actualLeft = points[i] * dadsFactor;
            var actualHeight = bottomLineHeight - (points[i + 1] * dadsFactor);
            var actualRight = points[i + 2] * dadsFactor;

            if (actualHeight > 0) {
                ctx.lineTo(actualLeft, actualHeight);
            }
            if (actualRight > 0) {
                ctx.lineTo(actualRight, actualHeight);
            }
        }
        ctx.lineTo(points[points.length - 1] * dadsFactor, bottomLineHeight);
        ctx.stroke();
    }

    function calculateSkyline(houses) {
        if (houses.length === 1) {
            // Return the coordinates for this house
            return houses[0];
        }

        // Split the houses
        var halfPoint = Math.ceil(houses.length / 2);
        var leftSide = houses.slice(0, halfPoint);
        var rightSide = houses.slice(halfPoint);

        // Run recursively on the houses
        var leftSkyline = calculateSkyline(leftSide);
        var rightSkyline = calculateSkyline(rightSide);

        // Combine
        var skyline = [];

        var ri = 0;
        var li = 0;
        var lHeight = 0;
        var rHeight = 0;
        var x = 0;
        while (leftSkyline.length >= li || rightSkyline.length >= ri) {
            // get the leftmost of the two
            var left = leftSkyline[li];
            var right = rightSkyline[ri];

            // Make sure we halt when out of bounds
            if (left == undefined) {
                left = 1000000;
            }
            if (right == undefined) {
                right = 1000000;
            }

            // Pick the smaller
            if (left < right) {
                x = leftSkyline[li]; // 23
                if (leftSkyline[li + 1] != undefined) {
                    lHeight = leftSkyline[li + 1]; // 13
                }
                else {
                    lHeight = 0;
                }
                li += 2;
            }
            else {
                x = rightSkyline[ri];

                if (rightSkyline[ri + 1] != undefined) {
                    rHeight = rightSkyline[ri + 1];
                }
                else {
                    rHeight = 0;
                }
                ri += 2;
            }

            skyline.push(x);

            if (ri < rightSkyline.length || li < leftSkyline.length) {
                skyline.push(Math.max(lHeight, rHeight));
            }
        }
        return skyline;
    }
</script>
</body>
</html>